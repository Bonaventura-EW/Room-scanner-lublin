name: ðŸ  Room Scanner - Lublin

on:
  schedule:
    # Codziennie o 10:00 UTC (11:00/12:00 w Polsce)
    - cron: '0 10 * * *'
    # Codziennie o 18:00 UTC (19:00/20:00 w Polsce)  
    - cron: '0 18 * * *'
  
  # Pozwala na rÄ™czne uruchomienie
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

# Pozwolenia dla GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Tylko jeden workflow jednoczeÅ›nie
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ  Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ðŸ“¥ Install dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 folium lxml sqlite3 schedule
        
    - name: ðŸ—‚ï¸ Create data directories
      run: |
        mkdir -p data
        mkdir -p docs
        
    - name: ðŸ’¾ Restore database and cache
      uses: actions/cache@v3
      with:
        path: |
          data/
        key: olx-monitor-data-${{ github.run_number }}
        restore-keys: |
          olx-monitor-data-
          
    - name: ðŸ” Run Room Scanner
      run: |
        echo "ðŸš€ Starting Room Scanner - Lublin at $(date)"
        python olx_room_monitor.py
        echo "âœ… Monitoring completed at $(date)"
        
    - name: ðŸ“Š Display statistics
      run: |
        if [ -f data/olx_rooms.db ]; then
          echo "ðŸ“Š Database statistics:"
          sqlite3 data/olx_rooms.db "SELECT COUNT(*) as total_offers FROM offers;" || echo "No data yet"
          sqlite3 data/olx_rooms.db "SELECT COUNT(*) as active_offers FROM offers WHERE is_active=1;" || echo "No active offers"
          sqlite3 data/olx_rooms.db "SELECT COUNT(*) as inactive_offers FROM offers WHERE is_active=0;" || echo "No inactive offers"
        fi
        
        if [ -f docs/index.html ]; then
          echo "ðŸ—ºï¸ Map generated successfully"
          ls -la docs/
        fi
        
    - name: ðŸ—ºï¸ Setup GitHub Pages
      uses: actions/configure-pages@v3
      
    - name: ðŸ“¤ Upload Pages artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: 'docs'
        
    - name: ðŸŒ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    - name: ðŸ“‹ Create summary report
      run: |
        echo "# ðŸ  Room Scanner - Lublin Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Monitoring completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f data/olx_rooms.db ]; then
          TOTAL=$(sqlite3 data/olx_rooms.db "SELECT COUNT(*) FROM offers;" 2>/dev/null || echo "0")
          ACTIVE=$(sqlite3 data/olx_rooms.db "SELECT COUNT(*) FROM offers WHERE is_active=1;" 2>/dev/null || echo "0")
          INACTIVE=$(sqlite3 data/olx_rooms.db "SELECT COUNT(*) FROM offers WHERE is_active=0;" 2>/dev/null || echo "0")
          
          echo "## ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total offers found:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Currently active:** $ACTIVE" >> $GITHUB_STEP_SUMMARY
          echo "- **Historical (inactive):** $INACTIVE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f docs/index.html ]; then
          echo "## ðŸ—ºï¸ Interactive Map" >> $GITHUB_STEP_SUMMARY
          echo "Map has been updated and deployed to: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "## â° Next Monitoring" >> $GITHUB_STEP_SUMMARY
        echo "- **Next scheduled run:** Daily at 10:00 and 18:00 UTC" >> $GITHUB_STEP_SUMMARY
        echo "- **Time zone:** Poland (UTC+1/UTC+2)" >> $GITHUB_STEP_SUMMARY
        
    - name: âŒ Handle errors
      if: failure()
      run: |
        echo "âŒ Monitoring failed!" >> $GITHUB_STEP_SUMMARY
        echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
        
        # Try to preserve any partial data
        if [ -f data/olx_rooms.db ]; then
          echo "ðŸ’¾ Database preserved for next run" >> $GITHUB_STEP_SUMMARY
        fi
